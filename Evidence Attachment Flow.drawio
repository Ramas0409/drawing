<mxfile host="app.diagrams.net" agent="Claude" version="24.7.1">
  <diagram id="evidence-flow" name="Evidence Attachment Flow">
    <mxGraphModel dx="646" dy="416" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1400" pageHeight="5000" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        
        <!-- TITLE -->
        <mxCell id="title" value="EVIDENCE ATTACHMENT &amp; NOTIFICATION FLOW - STEP BY STEP" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;fontSize=20;fontStyle=1;fontColor=#1b5e20;" parent="1" vertex="1">
          <mxGeometry x="100" y="20" width="1200" height="40" as="geometry" />
        </mxCell>

        <!-- STEP 1 -->
        <mxCell id="step1-box" value="STEP 1: EVIDENCE ZIP FILE ARRIVAL" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe0b2;strokeColor=#ef6c00;fontSize=14;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10;strokeWidth=2;" parent="1" vertex="1">
          <mxGeometry x="100" y="80" width="1200" height="140" as="geometry" />
        </mxCell>
        <mxCell id="step1-detail" value="Merchant uploads EVIDENCE-ONLY ZIP file to S3&#xa;&#xa;S3 Bucket: /inbound/evidence_merchant123_20250108.zip&#xa;Contents: evidence.csv + evidence files (receipts, invoices, photos)&#xa;&#xa;CSV Format: networkTransactionId, caseNumber, evidenceFiles&#xa;Example row: NET-001, CB-001, receipt1.jpg|invoice2.pdf|photo3.jpg&#xa;&#xa;Evidence files in ZIP: receipt1.jpg, invoice2.pdf, photo3.jpg (500 total files)&#xa;Note: CSV row count (100) ≠ evidence file count (500) - multiple files per case" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=11;spacingLeft=10;" parent="1" vertex="1">
          <mxGeometry x="110" y="110" width="1180" height="100" as="geometry" />
        </mxCell>

        <!-- STEP 2 -->
        <mxCell id="step2-box" value="STEP 2: S3 EVENT TRIGGER" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#c8e6c9;strokeColor=#2e7d32;fontSize=14;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10;strokeWidth=2;" parent="1" vertex="1">
          <mxGeometry x="100" y="240" width="1200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="step2-detail" value="S3 ObjectCreated event sent to SQS Queue&#xa;&#xa;SQS Queue: wdp-file-arrivals | Message: {bucket, key, file_name: evidence_merchant123_20250108.zip}" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=11;spacingLeft=10;" parent="1" vertex="1">
          <mxGeometry x="110" y="270" width="1180" height="40" as="geometry" />
        </mxCell>

        <!-- STEP 3 -->
        <mxCell id="step3-box" value="STEP 3: FILE PROCESSOR - EXTRACT AND CREATE TRACKING" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcdd2;strokeColor=#c62828;fontSize=14;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10;strokeWidth=2;" parent="1" vertex="1">
          <mxGeometry x="100" y="340" width="1200" height="260" as="geometry" />
        </mxCell>
        <mxCell id="step3-detail" value="File Processor extracts ZIP and detects EVIDENCE mode&#xa;&#xa;Mode Detection: CSV contains only case reference fields → classify as EVIDENCE_ATTACHMENT mode&#xa;Extract: evidence.csv (100 rows) + 500 evidence files&#xa;Upload evidence to: S3 /evidence-staging/file-job-456/ (organized by case)&#xa;&#xa;CREATE file_job:&#xa;INSERT file_job (id: file-job-456, file_name: evidence_merchant123_20250108.zip, &#xa;                  source_network: MERCHANT_123, file_mode: EVIDENCE_ATTACHMENT,&#xa;                  total_rows: 100, status: PROCESSING, ack_required: FALSE)&#xa;&#xa;CREATE file_job_row (one per CSV row):&#xa;INSERT file_job_row (id: row-501, file_job_id: file-job-456, row_number: 1, &#xa;                      status: PENDING, case_number: CB-001, evidence_count: 5,&#xa;                      evidence_s3_prefix: s3://wdp/evidence-staging/file-job-456/CB-001/)&#xa;&#xa;CREATE file_job_artifact (one per evidence file):&#xa;INSERT file_job_artifact (id: art-1001, file_job_id: file-job-456, file_job_row_id: row-501,&#xa;                          file_name: receipt1.jpg, file_type: IMAGE, file_size_bytes: 245000,&#xa;                          s3_key: s3://wdp/evidence-staging/file-job-456/CB-001/receipt1.jpg,&#xa;                          attachment_status: PENDING, retry_status: NULL, retry_count: 0)&#xa;&#xa;Result: 100 file_job_row records + 500 file_job_artifact records created&#xa;⭐ KEY: Three-table lineage tracks: ZIP → CSV rows → individual evidence files" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=10;spacingLeft=10;fontFamily=Courier New;" parent="1" vertex="1">
          <mxGeometry x="110" y="370" width="1180" height="220" as="geometry" />
        </mxCell>

        <!-- STEP 4 -->
        <mxCell id="step4-box" value="STEP 4: INSERT OUTBOX EVENTS (EVIDENCE_ATTACH_REQUESTED)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ce93d8;strokeColor=#6a1b9a;fontSize=14;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10;strokeWidth=2;" parent="1" vertex="1">
          <mxGeometry x="100" y="620" width="1200" height="200" as="geometry" />
        </mxCell>
        <mxCell id="step4-detail" value="File Processor inserts outbox events for evidence attachment&#xa;&#xa;TABLE: evidence.outbox&#xa;&#xa;For each file_job_row, create outbox record:&#xa;{event_type: EvidenceAttachRequested,&#xa; topic: evidence.attach.requests,&#xa; ack_required: FALSE,  ← No ACK for evidence-only files&#xa; payload: {&#xa;   fileJobId: file-job-456,&#xa;   fileJobRowId: row-501,&#xa;   caseId: case-001,&#xa;   caseNumber: CB-001,&#xa;   artifacts: [&#xa;     {artifactId: art-1001, s3Key: s3://.../receipt1.jpg, fileType: IMAGE},&#xa;     {artifactId: art-1002, s3Key: s3://.../invoice2.pdf, fileType: DOCUMENT},&#xa;     ... (5 artifacts for this case)&#xa;   ]}}&#xa;&#xa;Status: file_job_row.status = PENDING → waiting for attachment&#xa;⭐ KEY: Each outbox event contains ALL artifacts for ONE case (batched by case)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=10;spacingLeft=10;fontFamily=Courier New;" parent="1" vertex="1">
          <mxGeometry x="110" y="650" width="1180" height="160" as="geometry" />
        </mxCell>

        <!-- STEP 5 -->
        <mxCell id="step5-box" value="STEP 5: PUBLISH SCHEDULER → EVIDENCE.ATTACH.REQUESTS" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8bbd0;strokeColor=#c2185b;fontSize=14;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10;strokeWidth=2;" parent="1" vertex="1">
          <mxGeometry x="100" y="840" width="1200" height="120" as="geometry" />
        </mxCell>
        <mxCell id="step5-detail" value="Publish Scheduler reads evidence outbox and publishes to Kafka&#xa;&#xa;TABLE READ: evidence.outbox WHERE status = PENDING AND event_type = EvidenceAttachRequested&#xa;KAFKA TOPIC: evidence.attach.requests (partitions: 12, key: caseId for ordering)&#xa;&#xa;Event Payload: {fileJobId: file-job-456, caseId: case-001, artifacts: [...5 files...]}&#xa;&#xa;TABLE UPDATE: evidence.outbox SET status = PUBLISHED&#xa;⭐ 100 Kafka messages published (one per case)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=10;spacingLeft=10;fontFamily=Courier New;" parent="1" vertex="1">
          <mxGeometry x="110" y="870" width="1180" height="80" as="geometry" />
        </mxCell>

        <!-- STEP 6 -->
        <mxCell id="step6-box" value="STEP 6: EVIDENCE WORKER CONSUMES AND ATTACHES (BATCH)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#b2dfdb;strokeColor=#00695c;fontSize=14;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10;strokeWidth=2;" parent="1" vertex="1">
          <mxGeometry x="100" y="980" width="1200" height="200" as="geometry" />
        </mxCell>
        <mxCell id="step6-detail" value="Evidence Worker (3 instances) consume from Kafka and call Case Service&#xa;&#xa;KAFKA CONSUMER: evidence.attach.requests (consumer group: evidence-worker-group)&#xa;Batch size: 100 events (100 cases, 500 total files)&#xa;&#xa;CASE SERVICE API CALL (per case):&#xa;POST /api/case/{caseId}/evidence/bulk&#xa;Body: {&#xa;  artifacts: [&#xa;    {s3Key: s3://.../receipt1.jpg, fileType: IMAGE, fileName: receipt1.jpg},&#xa;    {s3Key: s3://.../invoice2.pdf, fileType: DOCUMENT, fileName: invoice2.pdf},&#xa;    ... (5 files for case-001)&#xa;  ]}&#xa;&#xa;Case Service validates each file:&#xa;- Case exists and is in valid state&#xa;- File format is supported (jpg, pdf, png, etc.)&#xa;- File size within limits (max 10MB per file)&#xa;- No duplicate file names for this case&#xa;&#xa;Response: Per-file results [{artifactId: art-1001, status: SUCCESS, caseEvidenceId: ev-001}, ...]" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=10;spacingLeft=10;fontFamily=Courier New;" parent="1" vertex="1">
          <mxGeometry x="110" y="1010" width="1180" height="160" as="geometry" />
        </mxCell>

        <!-- STEP 7 -->
        <mxCell id="step7-box" value="STEP 7: UPDATE file_job_artifact WITH RESULTS (PER-FILE STATUS)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff9c4;strokeColor=#f57f17;fontSize=14;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10;strokeWidth=2;" parent="1" vertex="1">
          <mxGeometry x="100" y="1200" width="1200" height="280" as="geometry" />
        </mxCell>
        <mxCell id="step7-detail" value="⭐ CRITICAL: Evidence Worker updates each artifact with attachment result&#xa;&#xa;For SUCCESSFUL attachments (475 files):&#xa;UPDATE file_job_artifact SET&#xa;  attachment_status = 'ATTACHED',&#xa;  case_evidence_id = 'ev-001',&#xa;  attached_at = NOW(),&#xa;  attempt_count = attempt_count + 1,&#xa;  updated_at = NOW()&#xa;WHERE id = art-1001;&#xa;&#xa;For TRANSIENT failures (20 files - network errors, 503s):&#xa;UPDATE file_job_artifact SET&#xa;  attachment_status = 'FAILED',&#xa;  attachment_error_code = '503',&#xa;  attachment_error_message = 'Service Unavailable',&#xa;  error_category = 'NETWORK',  ← Determines retry behavior&#xa;  retry_status = 'PENDING',     ← Will be retried&#xa;  retry_count = 0,&#xa;  next_retry_at = NOW() + INTERVAL '6 hours',&#xa;  attempt_count = attempt_count + 1,&#xa;  updated_at = NOW()&#xa;WHERE id = art-1015;&#xa;&#xa;For PERMANENT failures (5 files - corrupted, wrong format):&#xa;UPDATE file_job_artifact SET&#xa;  attachment_status = 'FAILED',&#xa;  attachment_error_code = 'CORRUPTED_FILE',&#xa;  attachment_error_message = 'File is corrupted or invalid format',&#xa;  error_category = 'DATA',&#xa;  retry_status = 'PERMANENT_FAILED',  ← Will NOT be retried&#xa;  updated_at = NOW()&#xa;WHERE id = art-1020;&#xa;&#xa;Result: 475 SUCCESS / 20 PENDING RETRY / 5 PERMANENT_FAILED" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=10;spacingLeft=10;fontFamily=Courier New;" parent="1" vertex="1">
          <mxGeometry x="110" y="1230" width="1180" height="240" as="geometry" />
        </mxCell>

        <!-- STEP 8 -->
        <mxCell id="step8-box" value="STEP 8: UPDATE file_job_row AGGREGATE STATUS" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1bee7;strokeColor=#7b1fa2;fontSize=14;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10;strokeWidth=2;" parent="1" vertex="1">
          <mxGeometry x="100" y="1500" width="1200" height="220" as="geometry" />
        </mxCell>
        <mxCell id="step8-detail" value="Evidence Worker updates row-level summary after processing all artifacts&#xa;&#xa;TABLE UPDATE: file_job_row&#xa;UPDATE file_job_row SET&#xa;  evidence_attached_count = 5,      ← Successfully attached files for this row&#xa;  evidence_failed_count = 0,        ← Permanent failures&#xa;  evidence_retry_pending_count = 0, ← Awaiting retry&#xa;  evidence_status = 'COMPLETED',    ← All artifacts processed (no retries pending)&#xa;  evidence_completed_at = NOW(),&#xa;  completed_at = NOW(),&#xa;  updated_at = NOW()&#xa;WHERE id = row-501 AND file_job_id = file-job-456;&#xa;&#xa;For rows with pending retries:&#xa;UPDATE file_job_row SET&#xa;  evidence_attached_count = 4,&#xa;  evidence_failed_count = 0,&#xa;  evidence_retry_pending_count = 1,&#xa;  evidence_status = 'PENDING_RETRY',  ← Some artifacts need retry&#xa;  updated_at = NOW()&#xa;WHERE id = row-502;&#xa;&#xa;⭐ KEY: evidence_final_status computed column shows: COMPLETED | PENDING_RETRY | PERMANENT_FAILED" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=10;spacingLeft=10;fontFamily=Courier New;" parent="1" vertex="1">
          <mxGeometry x="110" y="1530" width="1180" height="180" as="geometry" />
        </mxCell>

        <!-- STEP 9 -->
        <mxCell id="step9-box" value="STEP 9: EMIT EvidenceBatchCompleted EVENT" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#90caf9;strokeColor=#1565c0;fontSize=14;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10;strokeWidth=2;" parent="1" vertex="1">
          <mxGeometry x="100" y="1740" width="1200" height="180" as="geometry" />
        </mxCell>
        <mxCell id="step9-detail" value="⭐ Evidence Worker emits batch completion event to Kafka&#xa;&#xa;KAFKA TOPIC: evidence.batch.events&#xa;EVENT: EvidenceBatchCompleted&#xa;Payload: {&#xa;  eventType: 'EvidenceBatchCompleted',&#xa;  fileJobId: 'file-job-456',&#xa;  fileJobRowId: 'row-501',&#xa;  caseId: 'case-001',&#xa;  caseNumber: 'CB-001',&#xa;  totalArtifacts: 5,&#xa;  successCount: 5,&#xa;  failedCount: 0,&#xa;  retriableCount: 0,&#xa;  permanentFailedCount: 0,&#xa;  completedAt: '2025-01-08T10:35:00Z',&#xa;  nextRetryAt: null  ← No retry needed for this case&#xa;}&#xa;&#xa;⭐ For cases with retries: nextRetryAt: '2025-01-08T16:35:00Z' (T+6h)&#xa;⭐ KEY: This event triggers N1 notification" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=10;spacingLeft=10;fontFamily=Courier New;" parent="1" vertex="1">
          <mxGeometry x="110" y="1770" width="1180" height="140" as="geometry" />
        </mxCell>

        <!-- STEP 10 -->
        <mxCell id="step10-box" value="STEP 10: MERCHANT NOTIFICATION SERVICE AGGREGATES RESULTS" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffccbc;strokeColor=#bf360c;fontSize=14;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10;strokeWidth=2;" parent="1" vertex="1">
          <mxGeometry x="100" y="1940" width="1200" height="200" as="geometry" />
        </mxCell>
        <mxCell id="step10-detail" value="Merchant Notification Service subscribes to evidence.batch.events&#xa;&#xa;KAFKA CONSUMER: evidence.batch.events (filter: EvidenceBatchCompleted)&#xa;&#xa;Aggregates results by fileJobId:&#xa;- Group all EvidenceBatchCompleted events by fileJobId&#xa;- Wait for all 100 case events to arrive (or timeout after 5 minutes)&#xa;- Compute totals:&#xa;  * Total artifacts: 500&#xa;  * Successfully attached: 475 (95%)&#xa;  * Pending retry: 20 (4%)&#xa;  * Permanent failures: 5 (1%)&#xa;&#xa;Build N1 notification summary:&#xa;{&#xa;  fileJobId: 'file-job-456',&#xa;  merchantId: 'merchant-123',&#xa;  fileName: 'evidence_merchant123_20250108.zip',&#xa;  totalCases: 100,&#xa;  totalArtifacts: 500,&#xa;  successfulArtifacts: 475,&#xa;  pendingRetryArtifacts: 20,&#xa;  permanentFailedArtifacts: 5,&#xa;  casesWithRetries: 15,  ← 15 cases have at least one artifact pending retry&#xa;  nextRetryAt: '2025-01-08T16:35:00Z'&#xa;}" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=10;spacingLeft=10;fontFamily=Courier New;" parent="1" vertex="1">
          <mxGeometry x="110" y="1970" width="1180" height="160" as="geometry" />
        </mxCell>

        <!-- STEP 11 -->
        <mxCell id="step11-box" value="STEP 11: SEND N1 NOTIFICATION TO MERCHANT (IMMEDIATE)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#c8e6c9;strokeColor=#2e7d32;fontSize=14;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10;strokeWidth=2;" parent="1" vertex="1">
          <mxGeometry x="100" y="2160" width="1200" height="240" as="geometry" />
        </mxCell>
        <mxCell id="step11-detail" value="⭐ N1 Notification sent via Notification Orchestrator&#xa;&#xa;KAFKA TOPIC: merchant.evidence.status.notify&#xa;EVENT: {&#xa;  notificationType: 'EVIDENCE_ATTACHMENT_N1',&#xa;  merchantId: 'merchant-123',&#xa;  fileJobId: 'file-job-456',&#xa;  subject: 'Evidence Upload Processing Complete - Partial Success',&#xa;  summary: {&#xa;    totalFiles: 500,&#xa;    successfulFiles: 475,&#xa;    pendingRetryFiles: 20,&#xa;    permanentFailedFiles: 5,&#xa;    nextRetryAt: '2025-01-08T16:35:00Z'&#xa;  },&#xa;  channels: ['EMAIL', 'WEBHOOK', 'DASHBOARD']&#xa;}&#xa;&#xa;EMAIL TEMPLATE (N1):&#xa;Subject: Evidence Upload - 95% Attached Successfully&#xa;Body:&#xa;  Dear Merchant,&#xa;  &#xa;  Your evidence upload has been processed:&#xa;  ✓ 475 files attached successfully (95%)&#xa;  ⚠ 20 files will retry in 6 hours (4%)&#xa;  ✗ 5 files failed permanently (1%)&#xa;  &#xa;  We will send a final notification after automatic retry attempts.&#xa;  &#xa;MERCHANT DASHBOARD UPDATE:&#xa;Status: ⚠ Processing (95% complete)&#xa;Progress bar: 475/500&#xa;Message: &quot;20 files pending retry in 6 hours&quot;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=10;spacingLeft=10;fontFamily=Courier New;" parent="1" vertex="1">
          <mxGeometry x="110" y="2190" width="1180" height="200" as="geometry" />
        </mxCell>

        <!-- STEP 12 -->
        <mxCell id="step12-box" value="STEP 12: ⏰ 6 HOURS LATER - RETRY SCHEDULER RUNS" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8bbd0;strokeColor=#c2185b;fontSize=14;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10;strokeWidth=2;" parent="1" vertex="1">
          <mxGeometry x="100" y="2420" width="1200" height="220" as="geometry" />
        </mxCell>
        <mxCell id="step12-detail" value="Evidence Retry Scheduler runs every 10 minutes&#xa;&#xa;SCHEDULER QUERY (with row-level locking):&#xa;SELECT * FROM file_job_artifact&#xa;WHERE retry_status IN ('PENDING', 'RETRY_FAILED')&#xa;  AND next_retry_at &lt;= NOW()&#xa;  AND retry_count &lt; 2&#xa;ORDER BY next_retry_at ASC, created_at ASC&#xa;LIMIT 100&#xa;FOR UPDATE SKIP LOCKED;  ← Prevents duplicate processing&#xa;&#xa;FOUND: 20 artifacts ready for retry&#xa;&#xa;Scheduler republishes to Kafka:&#xa;KAFKA TOPIC: evidence.attach.requests (same topic as initial)&#xa;For each artifact, publish:&#xa;{&#xa;  eventType: 'EvidenceRetryRequested',&#xa;  fileJobId: 'file-job-456',&#xa;  artifactId: 'art-1015',&#xa;  caseId: 'case-005',&#xa;  s3Key: 's3://.../receipt15.jpg',&#xa;  retryCount: 1,&#xa;  originalErrorCode: '503'&#xa;}&#xa;&#xa;UPDATE file_job_artifact SET retry_status = 'RETRY_SCHEDULED', retry_count = 1" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=10;spacingLeft=10;fontFamily=Courier New;" parent="1" vertex="1">
          <mxGeometry x="110" y="2450" width="1180" height="180" as="geometry" />
        </mxCell>

        <!-- STEP 13 -->
        <mxCell id="step13-box" value="STEP 13: EVIDENCE WORKER PROCESSES RETRY (SAME LOGIC)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#b2dfdb;strokeColor=#00695c;fontSize=14;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10;strokeWidth=2;" parent="1" vertex="1">
          <mxGeometry x="100" y="2660" width="1200" height="180" as="geometry" />
        </mxCell>
        <mxCell id="step13-detail" value="Evidence Worker treats retry exactly like initial attempt&#xa;&#xa;KAFKA CONSUMER: evidence.attach.requests (no difference between initial vs retry)&#xa;&#xa;POST /api/case/{caseId}/evidence/bulk (same endpoint)&#xa;&#xa;RETRY RESULTS (20 files):&#xa;- 17 files: SUCCESS (network issue resolved) → attachment_status = ATTACHED&#xa;- 3 files: STILL FAILED (persistent network issue) → retry_count = 2 → PERMANENT_FAILED&#xa;&#xa;UPDATE file_job_artifact:&#xa;For successes:&#xa;  attachment_status = 'ATTACHED', retry_status = 'RETRY_SUCCESS', retry_count = 1&#xa;&#xa;For max retries exceeded:&#xa;  attachment_status = 'FAILED', retry_status = 'PERMANENT_FAILED', retry_count = 2&#xa;&#xa;UPDATE file_job_row (aggregate):&#xa;  evidence_attached_count = 4 + 1 = 5 (was 4, now 5 after retry)&#xa;  evidence_retry_pending_count = 1 - 1 = 0&#xa;  evidence_failed_count = 0 → 0 (if retry succeeded) or 0 → 1 (if permanent fail)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=10;spacingLeft=10;fontFamily=Courier New;" parent="1" vertex="1">
          <mxGeometry x="110" y="2690" width="1180" height="140" as="geometry" />
        </mxCell>

        <!-- STEP 14 -->
        <mxCell id="step14-box" value="STEP 14: EMIT EvidenceRetryCompleted EVENT" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#90caf9;strokeColor=#1565c0;fontSize=14;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10;strokeWidth=2;" parent="1" vertex="1">
          <mxGeometry x="100" y="2860" width="1200" height="160" as="geometry" />
        </mxCell>
        <mxCell id="step14-detail" value="Evidence Worker emits retry completion event&#xa;&#xa;KAFKA TOPIC: evidence.batch.events&#xa;EVENT: EvidenceRetryCompleted&#xa;Payload: {&#xa;  eventType: 'EvidenceRetryCompleted',&#xa;  fileJobId: 'file-job-456',&#xa;  fileJobRowId: 'row-502',&#xa;  caseId: 'case-005',&#xa;  originalFailures: 1,&#xa;  retrySuccessCount: 1,&#xa;  permanentFailCount: 0,&#xa;  retryCompletedAt: '2025-01-08T16:40:00Z'&#xa;}&#xa;&#xa;⭐ KEY: This event triggers N2 notification after ALL retries complete" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=10;spacingLeft=10;fontFamily=Courier New;" parent="1" vertex="1">
          <mxGeometry x="110" y="2890" width="1180" height="120" as="geometry" />
        </mxCell>

        <!-- STEP 15 -->
        <mxCell id="step15-box" value="STEP 15: MERCHANT NOTIFICATION SERVICE AGGREGATES RETRY RESULTS" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffccbc;strokeColor=#bf360c;fontSize=14;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10;strokeWidth=2;" parent="1" vertex="1">
          <mxGeometry x="100" y="3040" width="1200" height="180" as="geometry" />
        </mxCell>
        <mxCell id="step15-detail" value="Merchant Notification Service subscribes to EvidenceRetryCompleted events&#xa;&#xa;Aggregates retry results by fileJobId:&#xa;- Wait for all retry events for file-job-456&#xa;- Compute final totals:&#xa;  * Original successes: 475&#xa;  * Retry successes: 17&#xa;  * Final successes: 492 (98.4%)&#xa;  * Final permanent failures: 5 + 3 = 8 (1.6%)&#xa;&#xa;Build N2 notification summary:&#xa;{&#xa;  fileJobId: 'file-job-456',&#xa;  totalArtifacts: 500,&#xa;  finalSuccessful: 492,&#xa;  finalFailed: 8,&#xa;  retriedArtifacts: 20,&#xa;  retrySuccesses: 17,&#xa;  retryFailures: 3&#xa;}" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=10;spacingLeft=10;fontFamily=Courier New;" parent="1" vertex="1">
          <mxGeometry x="110" y="3070" width="1180" height="140" as="geometry" />
        </mxCell>

        <!-- STEP 16 -->
        <mxCell id="step16-box" value="STEP 16: SEND N2 NOTIFICATION TO MERCHANT (FINAL STATUS)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#c8e6c9;strokeColor=#2e7d32;fontSize=14;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10;strokeWidth=2;" parent="1" vertex="1">
          <mxGeometry x="100" y="3240" width="1200" height="260" as="geometry" />
        </mxCell>
        <mxCell id="step16-detail" value="⭐ N2 Notification sent via Notification Orchestrator (FINAL)&#xa;&#xa;KAFKA TOPIC: merchant.evidence.status.notify&#xa;EVENT: {&#xa;  notificationType: 'EVIDENCE_ATTACHMENT_N2',&#xa;  merchantId: 'merchant-123',&#xa;  fileJobId: 'file-job-456',&#xa;  subject: 'Evidence Upload Final Status - 98% Success',&#xa;  summary: {&#xa;    totalFiles: 500,&#xa;    finalSuccessful: 492,&#xa;    finalFailed: 8,&#xa;    retriedFiles: 20,&#xa;    retrySuccesses: 17&#xa;  }&#xa;}&#xa;&#xa;EMAIL TEMPLATE (N2):&#xa;Subject: Evidence Upload Final Status - 98% Success&#xa;Body:&#xa;  Dear Merchant,&#xa;  &#xa;  Your evidence upload processing is complete:&#xa;  ✓ 492 files attached successfully (98.4%)&#xa;  ✗ 8 files failed permanently (1.6%)&#xa;  &#xa;  Retry results:&#xa;  • 17 files succeeded after retry&#xa;  • 3 files failed after maximum retry attempts&#xa;  &#xa;  ⚠ Action Required:&#xa;  Please review the 8 failed files and re-upload if needed.&#xa;  Download error report: [Link]&#xa;  &#xa;MERCHANT DASHBOARD UPDATE:&#xa;Status: ⚠ Partial Success (98% complete)&#xa;Final result: 492/500 files attached&#xa;Action: [Download Error Report] [Re-upload Failed Files]" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=10;spacingLeft=10;fontFamily=Courier New;" parent="1" vertex="1">
          <mxGeometry x="110" y="3270" width="1180" height="220" as="geometry" />
        </mxCell>

        <!-- STEP 17 -->
        <mxCell id="step17-box" value="STEP 17: UPDATE FILE JOB STATUS TO COMPLETED" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1bee7;strokeColor=#7b1fa2;fontSize=14;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10;strokeWidth=2;" parent="1" vertex="1">
          <mxGeometry x="100" y="3520" width="1200" height="140" as="geometry" />
        </mxCell>
        <mxCell id="step17-detail" value="Update file_job status to mark processing complete&#xa;&#xa;TABLE UPDATE: file_job&#xa;UPDATE file_job SET&#xa;  status = 'COMPLETED',&#xa;  processed_rows = 100,&#xa;  successful_artifacts = 492,&#xa;  failed_artifacts = 8,&#xa;  completed_at = NOW()&#xa;WHERE id = 'file-job-456';&#xa;&#xa;⭐ FILE PROCESSING LIFECYCLE COMPLETE&#xa;Total time: ~6 hours 5 minutes (initial + retry + notifications)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=10;spacingLeft=10;fontFamily=Courier New;" parent="1" vertex="1">
          <mxGeometry x="110" y="3550" width="1180" height="100" as="geometry" />
        </mxCell>

        <!-- KEY COMPONENTS -->
        <mxCell id="components-box" value="KEY COMPONENTS FOR EVIDENCE ATTACHMENT &amp; NOTIFICATION" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e3f2fd;strokeColor=#1565c0;fontSize=16;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10;strokeWidth=3;" parent="1" vertex="1">
          <mxGeometry x="100" y="3700" width="1200" height="340" as="geometry" />
        </mxCell>
        <mxCell id="components-detail" value="1. FILE PROCESSOR&#xa;   - Extracts ZIP and creates file_job, file_job_row, file_job_artifact records&#xa;   - Uploads evidence files to S3 /evidence-staging/&#xa;   - Creates outbox events (EvidenceAttachRequested) per case&#xa;&#xa;2. EVIDENCE WORKER (Consumer)&#xa;   - Subscribes to: evidence.attach.requests&#xa;   - Calls: Case Service POST /case/{id}/evidence/bulk&#xa;   - Updates: file_job_artifact.attachment_status (ATTACHED | FAILED)&#xa;   - Emits: EvidenceBatchCompleted events (per case)&#xa;&#xa;3. EVIDENCE RETRY SCHEDULER&#xa;   - Runs every 10 minutes&#xa;   - Query: SELECT * FROM file_job_artifact WHERE retry_status='PENDING' AND next_retry_at&lt;=NOW()&#xa;   - Republishes to: evidence.attach.requests (same topic)&#xa;   - Updates: retry_status = RETRY_SCHEDULED, retry_count++&#xa;&#xa;4. MERCHANT NOTIFICATION SERVICE&#xa;   - Subscribes to: evidence.batch.events (EvidenceBatchCompleted, EvidenceRetryCompleted)&#xa;   - Aggregates: Results by fileJobId&#xa;   - Publishes: merchant.evidence.status.notify (N1 immediate, N2 after retry)&#xa;&#xa;5. NOTIFICATION ORCHESTRATOR&#xa;   - Subscribes to: merchant.evidence.status.notify&#xa;   - Sends: Email, webhook, dashboard updates&#xa;   - Channels: Configured per merchant preference&#xa;&#xa;6. FILE_JOB_ARTIFACT STATUS STATES&#xa;   PENDING → Initial state after extraction&#xa;   ATTACHED → Successfully attached to case&#xa;   FAILED (retriable) → retry_status = PENDING, will retry&#xa;   FAILED (permanent) → retry_status = PERMANENT_FAILED, max retries exceeded&#xa;   ⭐ Terminal states: ATTACHED, PERMANENT_FAILED" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=11;spacingLeft=10;fontFamily=Courier New;" parent="1" vertex="1">
          <mxGeometry x="110" y="3730" width="1180" height="300" as="geometry" />
        </mxCell>

        <!-- NOTIFICATION COMPARISON -->
        <mxCell id="notif-box" value="N1 vs N2 NOTIFICATION COMPARISON" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff9c4;strokeColor=#f57f17;fontSize=16;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10;strokeWidth=3;" parent="1" vertex="1">
          <mxGeometry x="100" y="4080" width="1200" height="280" as="geometry" />
        </mxCell>
        <mxCell id="notif-detail" value="N1 NOTIFICATION (IMMEDIATE - T+1 minute)&#xa;Trigger: After initial attachment batch completes&#xa;Purpose: Provide immediate feedback with promise of retry&#xa;Timing: Sent within 1-2 minutes of file upload&#xa;Content:&#xa;  - Total files processed&#xa;  - Successfully attached count&#xa;  - Files pending retry (with retry time: T+6h)&#xa;  - Permanent failures (no retry)&#xa;  - Estimated retry completion time&#xa;Tone: Informational with forward-looking action (retry pending)&#xa;Example: &quot;95% success, 4% retrying in 6 hours, 1% failed&quot;&#xa;&#xa;N2 NOTIFICATION (FINAL - T+6h 5min)&#xa;Trigger: After ALL retry attempts complete&#xa;Purpose: Provide final status and actionable next steps&#xa;Timing: Sent after 6+ hours (after retry window)&#xa;Content:&#xa;  - Final attachment statistics&#xa;  - Retry success rate&#xa;  - Permanent failures requiring manual action&#xa;  - Link to error report&#xa;  - Call-to-action: Re-upload failed files&#xa;Tone: Actionable with clear merchant responsibility&#xa;Example: &quot;98% final success, 2% failed - action required&quot;&#xa;&#xa;⭐ KEY DIFFERENCE:&#xa;N1 = Status + Promise of retry&#xa;N2 = Final status + Call to action" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=11;spacingLeft=10;fontFamily=Courier New;" parent="1" vertex="1">
          <mxGeometry x="110" y="4110" width="1180" height="240" as="geometry" />
        </mxCell>

        <!-- DATABASE TABLES -->
        <mxCell id="db-box" value="DATABASE TABLE STRUCTURES" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffccbc;strokeColor=#bf360c;fontSize=16;fontStyle=1;align=left;verticalAlign=top;spacingLeft=10;strokeWidth=3;" parent="1" vertex="1">
          <mxGeometry x="100" y="4400" width="1200" height="440" as="geometry" />
        </mxCell>
        <mxCell id="db-detail" value="file_job (ZIP-level tracking)&#xa;├─ id: file-job-456&#xa;├─ file_name: evidence_merchant123_20250108.zip&#xa;├─ source_network: MERCHANT_123&#xa;├─ file_mode: EVIDENCE_ATTACHMENT&#xa;├─ total_rows: 100 (CSV rows)&#xa;├─ status: PROCESSING → COMPLETED&#xa;├─ successful_artifacts: 492&#xa;├─ failed_artifacts: 8&#xa;└─ ack_required: FALSE (no ACK for evidence-only)&#xa;&#xa;file_job_row (CSV row / case-level tracking)&#xa;├─ id: row-501&#xa;├─ file_job_id: file-job-456&#xa;├─ row_number: 1&#xa;├─ case_id: case-001&#xa;├─ case_number: CB-001&#xa;├─ evidence_count: 5 (artifacts for this case)&#xa;├─ evidence_attached_count: 5 (successful)&#xa;├─ evidence_failed_count: 0 (permanent failures)&#xa;├─ evidence_retry_pending_count: 0&#xa;├─ evidence_status: COMPLETED&#xa;├─ evidence_final_status: COMPUTED (COMPLETED | PENDING_RETRY | PERMANENT_FAILED)&#xa;└─ evidence_completed_at: 2025-01-08T16:40:00Z&#xa;&#xa;file_job_artifact (Individual evidence file tracking) ⭐ CRITICAL&#xa;├─ id: art-1001&#xa;├─ file_job_id: file-job-456&#xa;├─ file_job_row_id: row-501&#xa;├─ file_name: receipt1.jpg&#xa;├─ file_type: IMAGE&#xa;├─ file_size_bytes: 245000&#xa;├─ s3_key: s3://wdp/evidence-staging/file-job-456/CB-001/receipt1.jpg&#xa;├─ attachment_status: PENDING → ATTACHED | FAILED&#xa;├─ attachment_error_code: 503, CORRUPTED_FILE, etc.&#xa;├─ error_category: NETWORK | SYSTEM | DATA | AUTH&#xa;├─ case_evidence_id: ev-001 (from Case Service)&#xa;├─ attached_at: 2025-01-08T10:35:30Z&#xa;├─ retry_status: PENDING | RETRY_SCHEDULED | RETRY_SUCCESS | PERMANENT_FAILED&#xa;├─ retry_count: 0 → 1 → 2 (max)&#xa;├─ next_retry_at: 2025-01-08T16:35:00Z&#xa;├─ last_retry_at: 2025-01-08T16:35:05Z&#xa;└─ attempt_count: Total attempts including initial + retries" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=10;spacingLeft=10;fontFamily=Courier New;" parent="1" vertex="1">
          <mxGeometry x="110" y="4430" width="1180" height="400" as="geometry" />
        </mxCell>

        <!-- ARROWS -->
        <mxCell id="arr1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#ef6c00;entryX=0.5;entryY=0;" parent="1" source="step1-box" target="step2-box" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arr2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#2e7d32;entryX=0.5;entryY=0;" parent="1" source="step2-box" target="step3-box" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arr3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#c62828;entryX=0.5;entryY=0;" parent="1" source="step3-box" target="step4-box" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arr4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#6a1b9a;entryX=0.5;entryY=0;" parent="1" source="step4-box" target="step5-box" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arr5" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#c2185b;entryX=0.5;entryY=0;" parent="1" source="step5-box" target="step6-box" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arr6" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#00695c;entryX=0.5;entryY=0;" parent="1" source="step6-box" target="step7-box" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arr7" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#f57f17;entryX=0.5;entryY=0;" parent="1" source="step7-box" target="step8-box" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arr8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#7b1fa2;entryX=0.5;entryY=0;" parent="1" source="step8-box" target="step9-box" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arr9" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#1565c0;entryX=0.5;entryY=0;" parent="1" source="step9-box" target="step10-box" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arr10" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#bf360c;entryX=0.5;entryY=0;" parent="1" source="step10-box" target="step11-box" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arr11" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#2e7d32;entryX=0.5;entryY=0;" parent="1" source="step11-box" target="step12-box" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arr12" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#c2185b;entryX=0.5;entryY=0;" parent="1" source="step12-box" target="step13-box" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arr13" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#00695c;entryX=0.5;entryY=0;" parent="1" source="step13-box" target="step14-box" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arr14" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#1565c0;entryX=0.5;entryY=0;" parent="1" source="step14-box" target="step15-box" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arr15" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#bf360c;entryX=0.5;entryY=0;" parent="1" source="step15-box" target="step16-box" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arr16" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#2e7d32;entryX=0.5;entryY=0;" parent="1" source="step16-box" target="step17-box" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>