<mxfile host="app.diagrams.net" modified="2025-10-09T14:30:00.000Z" agent="Claude" version="22.1.0" type="device">
  <diagram name="Stage 1.4 Enhanced" id="enhanced-unified-outbox">
    <mxGraphModel dx="2400" dy="1600" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1800" pageHeight="1400" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        
        <!-- Background Sections -->
        <mxCell id="bg-ingestion" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#E8F5E9;strokeColor=#4CAF50;opacity=30;" vertex="1" parent="1">
          <mxGeometry x="40" y="80" width="320" height="320" as="geometry" />
        </mxCell>
        
        <mxCell id="bg-database" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#E3F2FD;strokeColor=#2196F3;opacity=30;" vertex="1" parent="1">
          <mxGeometry x="400" y="80" width="420" height="700" as="geometry" />
        </mxCell>
        
        <mxCell id="bg-publisher" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFF3E0;strokeColor=#FF9800;opacity=30;" vertex="1" parent="1">
          <mxGeometry x="860" y="80" width="300" height="300" as="geometry" />
        </mxCell>
        
        <mxCell id="bg-kafka" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#F3E5F5;strokeColor=#9C27B0;opacity=30;" vertex="1" parent="1">
          <mxGeometry x="1200" y="80" width="280" height="200" as="geometry" />
        </mxCell>
        
        <mxCell id="bg-consumer" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FCE4EC;strokeColor=#E91E63;opacity=30;" vertex="1" parent="1">
          <mxGeometry x="1200" y="320" width="280" height="320" as="geometry" />
        </mxCell>
        
        <mxCell id="bg-notification" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#FBC02D;opacity=30;" vertex="1" parent="1">
          <mxGeometry x="860" y="420" width="300" height="360" as="geometry" />
        </mxCell>
        
        <!-- Title -->
        <mxCell id="title" value="Stage 1.4: Enhanced Unified File Outbox Model with Notification Timing" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=20;fontStyle=1;fontColor=#1565C0;" vertex="1" parent="1">
          <mxGeometry x="400" y="20" width="900" height="40" as="geometry" />
        </mxCell>
        
        <!-- Layer Labels -->
        <mxCell id="label-ingestion" value="1. FILE INGESTION" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=1;fontColor=#2E7D32;" vertex="1" parent="1">
          <mxGeometry x="50" y="90" width="140" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="label-database" value="2. DATABASE (Aurora PostgreSQL)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=1;fontColor=#1565C0;" vertex="1" parent="1">
          <mxGeometry x="410" y="90" width="240" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="label-publisher" value="3. PUBLISHER SCHEDULER" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=1;fontColor=#E65100;" vertex="1" parent="1">
          <mxGeometry x="870" y="90" width="180" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="label-kafka" value="4. KAFKA TOPIC" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=1;fontColor=#6A1B9A;" vertex="1" parent="1">
          <mxGeometry x="1210" y="90" width="120" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="label-consumer" value="5. EVIDENCE WORKER" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=1;fontColor=#AD1457;" vertex="1" parent="1">
          <mxGeometry x="1210" y="330" width="140" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="label-notification" value="6. NOTIFICATIONS" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=1;fontColor=#F9A825;" vertex="1" parent="1">
          <mxGeometry x="870" y="430" width="120" height="20" as="geometry" />
        </mxCell>
        
        <!-- S3 Bucket -->
        <mxCell id="s3" value="&lt;b&gt;S3 Bucket&lt;/b&gt;&lt;br&gt;ZIP Upload&lt;br&gt;(CSV + Evidence)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#66BB6A;strokeColor=#388E3C;fontColor=#FFFFFF;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="80" y="130" width="120" height="70" as="geometry" />
        </mxCell>
        
        <!-- File Processor -->
        <mxCell id="file-processor" value="&lt;b&gt;File Processor&lt;/b&gt;&lt;br&gt;1. Parse CSV&lt;br&gt;2. Extract Evidence&lt;br&gt;3. Upload to S3&lt;br&gt;4. Insert to DB" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#66BB6A;strokeColor=#388E3C;fontColor=#FFFFFF;fontSize=10;align=left;spacingLeft=5;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="80" y="230" width="120" height="140" as="geometry" />
        </mxCell>
        
        <!-- Database Tables Container -->
        <mxCell id="db-container" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#BBDEFB;strokeColor=#1976D2;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="420" y="120" width="380" height="640" as="geometry" />
        </mxCell>
        
        <!-- file_job table -->
        <mxCell id="table-file-job" value="&lt;b&gt;file_job&lt;/b&gt;&lt;br&gt;â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€&lt;br&gt;id (PK)&lt;br&gt;file_name&lt;br&gt;source_network&lt;br&gt;status: PROCESSING&lt;br&gt;&amp;nbsp;&amp;nbsp;Ã¢â€ ' COMPLETED&lt;br&gt;total_rows&lt;br&gt;success_count&lt;br&gt;error_count&lt;br&gt;created_at" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#42A5F5;strokeColor=#1976D2;fontColor=#FFFFFF;fontSize=9;align=left;spacingLeft=5;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="440" y="140" width="160" height="140" as="geometry" />
        </mxCell>
        
        <!-- file_outbox_row table -->
        <mxCell id="table-outbox-row" value="&lt;b&gt;file_outbox_row&lt;/b&gt;&lt;br&gt;(Unified Row + Outbox)&lt;br&gt;â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€&lt;br&gt;id (PK)&lt;br&gt;file_job_id (FK)&lt;br&gt;case_id&lt;br&gt;row_number&lt;br&gt;status: PENDING&lt;br&gt;&amp;nbsp;&amp;nbsp;Ã¢â€ ' PUBLISHED&lt;br&gt;&amp;nbsp;&amp;nbsp;Ã¢â€ ' SUCCESS/FAILED&lt;br&gt;retry_count (0-2)&lt;br&gt;next_retry_at&lt;br&gt;publish_idempotency_key&lt;br&gt;error_code, error_msg" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#1976D2;strokeColor=#0D47A1;fontColor=#FFFFFF;fontSize=9;align=left;spacingLeft=5;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="440" y="300" width="160" height="180" as="geometry" />
        </mxCell>
        
        <!-- file_job_artifact table -->
        <mxCell id="table-artifact" value="&lt;b&gt;file_job_artifact&lt;/b&gt;&lt;br&gt;(Evidence Files)&lt;br&gt;â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€&lt;br&gt;id (PK)&lt;br&gt;file_outbox_row_id (FK)&lt;br&gt;artifact_type:&lt;br&gt;&amp;nbsp;&amp;nbsp;EVIDENCE&lt;br&gt;&amp;nbsp;&amp;nbsp;RECEIPT&lt;br&gt;&amp;nbsp;&amp;nbsp;INVOICE&lt;br&gt;file_name&lt;br&gt;s3_key, s3_bucket&lt;br&gt;attachment_status:&lt;br&gt;&amp;nbsp;&amp;nbsp;PENDING&lt;br&gt;&amp;nbsp;&amp;nbsp;Ã¢â€ ' ATTACHED&lt;br&gt;document_mgmt_id" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#42A5F5;strokeColor=#1976D2;fontColor=#FFFFFF;fontSize=9;align=left;spacingLeft=5;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="620" y="300" width="160" height="200" as="geometry" />
        </mxCell>
        
        <!-- file_outbox_row_audit table -->
        <mxCell id="table-audit" value="&lt;b&gt;file_outbox_row_audit&lt;/b&gt;&lt;br&gt;(State Transitions)&lt;br&gt;â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€&lt;br&gt;id (PK)&lt;br&gt;file_outbox_row_id (FK)&lt;br&gt;old_status&lt;br&gt;new_status&lt;br&gt;retry_count&lt;br&gt;error_code&lt;br&gt;transitioned_by:&lt;br&gt;&amp;nbsp;&amp;nbsp;FILE_PROCESSOR&lt;br&gt;&amp;nbsp;&amp;nbsp;PUBLISHER&lt;br&gt;&amp;nbsp;&amp;nbsp;EVIDENCE_WORKER&lt;br&gt;&amp;nbsp;&amp;nbsp;ADMIN&lt;br&gt;transitioned_at" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#42A5F5;strokeColor=#1976D2;fontColor=#FFFFFF;fontSize=9;align=left;spacingLeft=5;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="440" y="500" width="160" height="180" as="geometry" />
        </mxCell>
        
        <!-- State Machine -->
        <mxCell id="state-machine-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1F5FE;strokeColor=#0277BD;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="620" y="520" width="160" height="220" as="geometry" />
        </mxCell>
        
        <mxCell id="state-label" value="&lt;b&gt;State Machine&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontStyle=1;fontColor=#01579B;" vertex="1" parent="1">
          <mxGeometry x="620" y="525" width="160" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="state-pending" value="PENDING" style="ellipse;whiteSpace=wrap;html=1;fillColor=#FFF59D;strokeColor=#F9A825;fontSize=9;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="650" y="555" width="100" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="state-published" value="PUBLISHED" style="ellipse;whiteSpace=wrap;html=1;fillColor=#90CAF9;strokeColor=#1976D2;fontSize=9;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="650" y="600" width="100" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="state-success" value="SUCCESS" style="ellipse;whiteSpace=wrap;html=1;fillColor=#81C784;strokeColor=#388E3C;fontSize=9;fontStyle=1;fontColor=#FFFFFF;" vertex="1" parent="1">
          <mxGeometry x="650" y="680" width="100" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="state-failed" value="FAILED&lt;br&gt;(retry&amp;lt;2)" style="ellipse;whiteSpace=wrap;html=1;fillColor=#FFAB91;strokeColor=#D84315;fontSize=9;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="635" y="640" width="60" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="state-error" value="ERROR&lt;br&gt;(retry=2)" style="ellipse;whiteSpace=wrap;html=1;fillColor=#E57373;strokeColor=#C62828;fontSize=9;fontStyle=1;fontColor=#FFFFFF;" vertex="1" parent="1">
          <mxGeometry x="705" y="640" width="60" height="30" as="geometry" />
        </mxCell>
        
        <!-- State Arrows -->
        <mxCell id="arrow-state-1" value="" style="endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeWidth=2;strokeColor=#1976D2;" edge="1" parent="1" source="state-pending" target="state-published">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="800" y="700" as="sourcePoint" />
            <mxPoint x="850" y="650" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow-state-2" value="" style="endArrow=classic;html=1;rounded=0;exitX=0;exitY=1;exitDx=0;exitDy=0;entryX=1;entryY=0;entryDx=0;entryDy=0;strokeWidth=2;strokeColor=#388E3C;" edge="1" parent="1" source="state-published" target="state-success">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="800" y="700" as="sourcePoint" />
            <mxPoint x="850" y="650" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow-state-3" value="" style="endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeWidth=2;strokeColor=#D84315;dashed=1;" edge="1" parent="1" source="state-published" target="state-failed">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="800" y="700" as="sourcePoint" />
            <mxPoint x="850" y="650" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow-state-4" value="" style="endArrow=classic;html=1;rounded=0;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;strokeWidth=2;strokeColor=#F9A825;dashed=1;curved=1;" edge="1" parent="1" source="state-failed" target="state-pending">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="625" y="655" as="sourcePoint" />
            <mxPoint x="640" y="570" as="targetPoint" />
            <Array as="points">
              <mxPoint x="620" y="655" />
              <mxPoint x="620" y="570" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow-state-5" value="" style="endArrow=classic;html=1;rounded=0;exitX=1;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=0;entryDx=0;entryDy=0;strokeWidth=2;strokeColor=#C62828;" edge="1" parent="1" source="state-published" target="state-error">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="800" y="700" as="sourcePoint" />
            <mxPoint x="850" y="650" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Publisher Scheduler -->
        <mxCell id="publisher" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#E65100;" vertex="1" parent="1">
          <mxGeometry x="880" y="120" width="260" height="240" as="geometry" />
        </mxCell>
        
        <mxCell id="publisher-title" value="&lt;b&gt;Publisher Scheduler&lt;/b&gt;&lt;br&gt;(Runs every 2 minutes)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=1;fontColor=#E65100;" vertex="1" parent="1">
          <mxGeometry x="880" y="130" width="260" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="publisher-query" value="SELECT * FROM file_outbox_row&lt;br&gt;WHERE status='PENDING'&lt;br&gt;OR (status='FAILED' &amp;amp;&amp;amp;&lt;br&gt;&amp;nbsp;&amp;nbsp;retry_count&amp;lt;2 &amp;amp;&amp;amp;&lt;br&gt;&amp;nbsp;&amp;nbsp;next_retry_at&amp;lt;=NOW())&lt;br&gt;FOR UPDATE SKIP LOCKED&lt;br&gt;LIMIT 100;" style="text;html=1;strokeColor=#FF6F00;fillColor=#FFF3E0;align=left;verticalAlign=top;whiteSpace=wrap;rounded=1;fontSize=9;fontFamily=Courier New;spacingLeft=5;spacingTop=5;" vertex="1" parent="1">
          <mxGeometry x="890" y="170" width="240" height="90" as="geometry" />
        </mxCell>
        
        <mxCell id="publisher-logic" value="For each row:&lt;br&gt;1. Build event (include retry_count)&lt;br&gt;2. Publish to Kafka&lt;br&gt;3. UPDATE status='PUBLISHED'&lt;br&gt;4. Write audit log" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=9;spacingLeft=5;" vertex="1" parent="1">
          <mxGeometry x="890" y="270" width="240" height="80" as="geometry" />
        </mxCell>
        
        <!-- Kafka Topic -->
        <mxCell id="kafka-topic" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#6A1B9A;" vertex="1" parent="1">
          <mxGeometry x="1220" y="120" width="240" height="140" as="geometry" />
        </mxCell>
        
        <mxCell id="kafka-title" value="&lt;b&gt;Kafka Topic&lt;/b&gt;&lt;br&gt;evidence.requests" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1;fontColor=#4A148C;" vertex="1" parent="1">
          <mxGeometry x="1220" y="130" width="240" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="kafka-config" value="Partitions: 12&lt;br&gt;Replication: 3&lt;br&gt;Retention: 90 days" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=9;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1230" y="165" width="220" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="kafka-event" value="Event: {&lt;br&gt;&amp;nbsp;&amp;nbsp;file_outbox_row_id&lt;br&gt;&amp;nbsp;&amp;nbsp;case_id&lt;br&gt;&amp;nbsp;&amp;nbsp;retry_count: 0/1/2&lt;br&gt;&amp;nbsp;&amp;nbsp;evidence_ids: [...]&lt;br&gt;&amp;nbsp;&amp;nbsp;idempotency_key&lt;br&gt;}" style="text;html=1;strokeColor=#7B1FA2;fillColor=#F3E5F5;align=left;verticalAlign=top;whiteSpace=wrap;rounded=1;fontSize=8;fontFamily=Courier New;spacingLeft=5;spacingTop=5;" vertex="1" parent="1">
          <mxGeometry x="1230" y="205" width="220" height="45" as="geometry" />
        </mxCell>
        
        <!-- Evidence Worker -->
        <mxCell id="consumer" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F8BBD0;strokeColor=#AD1457;" vertex="1" parent="1">
          <mxGeometry x="1220" y="360" width="240" height="260" as="geometry" />
        </mxCell>
        
        <mxCell id="consumer-title" value="&lt;b&gt;Evidence Attach Worker&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1;fontColor=#880E4F;" vertex="1" parent="1">
          <mxGeometry x="1220" y="370" width="240" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="consumer-logic" value="1. Consume event&lt;br&gt;2. Check retry_count (for metrics)&lt;br&gt;3. Fetch artifacts:&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;SELECT * FROM file_job_artifact&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;WHERE file_outbox_row_id=?&lt;br&gt;4. Call Document Mgmt API&lt;br&gt;5. Update file_job_artifact:&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;attachment_status='ATTACHED'&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;document_mgmt_id=&amp;lt;id&amp;gt;&lt;br&gt;6. Update file_outbox_row:&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;â€¢ SUCCESS (if all ok)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;â€¢ FAILED (if retry&amp;lt;2)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;â€¢ ERROR (if retry=2)&lt;br&gt;7. Write audit log" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=8;spacingLeft=10;spacingTop=5;" vertex="1" parent="1">
          <mxGeometry x="1230" y="400" width="220" height="200" as="geometry" />
        </mxCell>
        
        <mxCell id="doc-mgmt-api" value="&lt;b&gt;Document Mgmt API&lt;/b&gt;&lt;br&gt;Attach Evidences" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C5CAE9;strokeColor=#3F51B5;fontColor=#1A237E;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1520" y="480" width="120" height="50" as="geometry" />
        </mxCell>
        
        <!-- Notification Service -->
        <mxCell id="notification-service" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F9A825;" vertex="1" parent="1">
          <mxGeometry x="880" y="460" width="260" height="300" as="geometry" />
        </mxCell>
        
        <mxCell id="notification-title" value="&lt;b&gt;Notification Service&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1;fontColor=#F57F17;" vertex="1" parent="1">
          <mxGeometry x="880" y="470" width="260" height="20" as="geometry" />
        </mxCell>
        
        <!-- N1 Notification -->
        <mxCell id="n1-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F57F17;strokeWidth=3;" vertex="1" parent="1">
          <mxGeometry x="890" y="500" width="240" height="110" as="geometry" />
        </mxCell>
        
        <mxCell id="n1-title" value="&lt;b&gt;ðŸ”” N1: Initial Results&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=1;fontColor=#E65100;" vertex="1" parent="1">
          <mxGeometry x="890" y="505" width="240" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="n1-trigger" value="âš¡ TRIGGER: After first attempt&lt;br&gt;(retry_count=0 processing done)" style="text;html=1;strokeColor=#FF6F00;fillColor=#FFECB3;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=9;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="900" y="530" width="220" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="n1-query" value="SELECT file_job_id, status,&lt;br&gt;&amp;nbsp;&amp;nbsp;COUNT(*) as count&lt;br&gt;FROM file_outbox_row&lt;br&gt;WHERE file_job_id=?&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;amp;&amp;amp; retry_count=0&lt;br&gt;GROUP BY file_job_id, status" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=8;fontFamily=Courier New;spacingLeft=5;" vertex="1" parent="1">
          <mxGeometry x="900" y="560" width="220" height="45" as="geometry" />
        </mxCell>
        
        <!-- N2 Notification -->
        <mxCell id="n2-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#4CAF50;strokeWidth=3;" vertex="1" parent="1">
          <mxGeometry x="890" y="630" width="240" height="110" as="geometry" />
        </mxCell>
        
        <mxCell id="n2-title" value="&lt;b&gt;âœ… N2: Final Results&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=1;fontColor=#2E7D32;" vertex="1" parent="1">
          <mxGeometry x="890" y="635" width="240" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="n2-trigger" value="âš¡ TRIGGER: All retries complete&lt;br&gt;(All rows in SUCCESS or ERROR)" style="text;html=1;strokeColor=#4CAF50;fillColor=#E8F5E9;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=9;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="900" y="660" width="220" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="n2-query" value="SELECT file_job_id, status,&lt;br&gt;&amp;nbsp;&amp;nbsp;COUNT(*) as count&lt;br&gt;FROM file_outbox_row&lt;br&gt;WHERE file_job_id=?&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;amp;&amp;amp; status IN&lt;br&gt;&amp;nbsp;&amp;nbsp;('SUCCESS','ERROR')&lt;br&gt;GROUP BY file_job_id, status" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=8;fontFamily=Courier New;spacingLeft=5;" vertex="1" parent="1">
          <mxGeometry x="900" y="690" width="220" height="45" as="geometry" />
        </mxCell>
        
        <!-- Merchant -->
        <mxCell id="merchant" value="&lt;b&gt;Merchant&lt;/b&gt;&lt;br&gt;Receives:&lt;br&gt;â€¢ N1 (initial)&lt;br&gt;â€¢ N2 (final)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFECB3;strokeColor=#FF6F00;fontColor=#E65100;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="950" y="810" width="120" height="70" as="geometry" />
        </mxCell>
        
        <!-- Flow Arrows -->
        <mxCell id="arrow-1" value="Upload ZIP" style="endArrow=classic;html=1;rounded=0;strokeWidth=2;strokeColor=#2E7D32;fontSize=10;" edge="1" parent="1" source="s3" target="file-processor">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="500" as="sourcePoint" />
            <mxPoint x="450" y="450" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow-2" value="Insert Rows" style="endArrow=classic;html=1;rounded=0;strokeWidth=2;strokeColor=#1976D2;fontSize=9;" edge="1" parent="1" source="file-processor" target="table-file-job">
          <mxGeometry x="-0.2" width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="500" as="sourcePoint" />
            <mxPoint x="450" y="450" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow-2b" value="Insert Rows&lt;br&gt;+ Artifacts" style="endArrow=classic;html=1;rounded=0;strokeWidth=2;strokeColor=#1976D2;fontSize=9;" edge="1" parent="1" source="file-processor" target="table-outbox-row">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="500" as="sourcePoint" />
            <mxPoint x="450" y="450" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow-3" value="SELECT&lt;br&gt;(every 2 min)" style="endArrow=classic;html=1;rounded=0;strokeWidth=2;strokeColor=#E65100;fontSize=9;startArrow=classic;startFill=1;" edge="1" parent="1" source="publisher" target="table-outbox-row">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="500" as="sourcePoint" />
            <mxPoint x="450" y="450" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow-4" value="Publish Event&lt;br&gt;{retry_count}" style="endArrow=classic;html=1;rounded=0;strokeWidth=2;strokeColor=#6A1B9A;fontSize=10;" edge="1" parent="1" source="publisher" target="kafka-topic">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="500" as="sourcePoint" />
            <mxPoint x="450" y="450" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow-5" value="Consume" style="endArrow=classic;html=1;rounded=0;strokeWidth=2;strokeColor=#AD1457;fontSize=10;" edge="1" parent="1" source="kafka-topic" target="consumer">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="500" as="sourcePoint" />
            <mxPoint x="450" y="450" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow-6" value="Fetch" style="endArrow=classic;html=1;rounded=0;strokeWidth=2;strokeColor=#AD1457;fontSize=9;dashed=1;" edge="1" parent="1" source="consumer" target="table-artifact">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="500" as="sourcePoint" />
            <mxPoint x="450" y="450" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1180" y="450" />
              <mxPoint x="820" y="450" />
              <mxPoint x="820" y="400" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow-7" value="Update Status" style="endArrow=classic;html=1;rounded=0;strokeWidth=2;strokeColor=#C2185B;fontSize=9;dashed=1;" edge="1" parent="1" source="consumer" target="table-outbox-row">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="500" as="sourcePoint" />
            <mxPoint x="450" y="450" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1180" y="480" />
              <mxPoint x="840" y="480" />
              <mxPoint x="840" y="390" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow-7b" value="Update&lt;br&gt;Artifact" style="endArrow=classic;html=1;rounded=0;strokeWidth=2;strokeColor=#C2185B;fontSize=9;dashed=1;" edge="1" parent="1" source="consumer" target="table-artifact">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="500" as="sourcePoint" />
            <mxPoint x="450" y="450" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1180" y="500" />
              <mxPoint x="860" y="500" />
              <mxPoint x="860" y="420" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow-8" value="Write Audit" style="endArrow=classic;html=1;rounded=0;strokeWidth=2;strokeColor=#1976D2;fontSize=9;dashed=1;" edge="1" parent="1" source="consumer" target="table-audit">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="500" as="sourcePoint" />
            <mxPoint x="450" y="450" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1180" y="520" />
              <mxPoint x="800" y="520" />
              <mxPoint x="800" y="590" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow-9" value="Call API" style="endArrow=classic;html=1;rounded=0;strokeWidth=2;strokeColor=#3F51B5;fontSize=9;" edge="1" parent="1" source="consumer" target="doc-mgmt-api">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="500" as="sourcePoint" />
            <mxPoint x="450" y="450" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow-10" value="Query Stats&lt;br&gt;(N1)" style="endArrow=classic;html=1;rounded=0;strokeWidth=2;strokeColor=#FF6F00;fontSize=9;" edge="1" parent="1" source="n1-box" target="table-outbox-row">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="600" as="sourcePoint" />
            <mxPoint x="450" y="550" as="targetPoint" />
            <Array as="points">
              <mxPoint x="860" y="555" />
              <mxPoint x="860" y="420" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow-11" value="Query Stats&lt;br&gt;(N2)" style="endArrow=classic;html=1;rounded=0;strokeWidth=2;strokeColor=#4CAF50;fontSize=9;" edge="1" parent="1" source="n2-box" target="table-outbox-row">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="600" as="sourcePoint" />
            <mxPoint x="450" y="550" as="targetPoint" />
            <Array as="points">
              <mxPoint x="850" y="685" />
              <mxPoint x="850" y="440" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow-12" value="Send N1" style="endArrow=classic;html=1;rounded=0;strokeWidth=2;strokeColor=#FF6F00;fontSize=10;" edge="1" parent="1" source="n1-box" target="merchant">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="700" as="sourcePoint" />
            <mxPoint x="450" y="650" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow-13" value="Send N2" style="endArrow=classic;html=1;rounded=0;strokeWidth=2;strokeColor=#4CAF50;fontSize=10;" edge="1" parent="1" source="n2-box" target="merchant">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="700" as="sourcePoint" />
            <mxPoint x="450" y="650" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow-14" value="Update&lt;br&gt;file_job" style="endArrow=classic;html=1;rounded=0;strokeWidth=2;strokeColor=#1976D2;fontSize=9;dashed=1;" edge="1" parent="1" source="notification-service" target="table-file-job">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="400" as="sourcePoint" />
            <mxPoint x="450" y="350" as="targetPoint" />
            <Array as="points">
              <mxPoint x="820" y="610" />
              <mxPoint x="820" y="210" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <!-- Update Indicators -->
        <mxCell id="update-job-1" value="UPDATE:&lt;br&gt;status='PROCESSING'" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F57F17;fontSize=8;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="240" y="180" width="100" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="update-job-2" value="UPDATE:&lt;br&gt;status='COMPLETED'&lt;br&gt;success/error counts" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=8;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="750" y="620" width="100" height="45" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow-job-update-1" value="" style="endArrow=classic;html=1;rounded=0;strokeWidth=1;strokeColor=#F57F17;dashed=1;" edge="1" parent="1" source="update-job-1" target="table-file-job">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="400" as="sourcePoint" />
            <mxPoint x="450" y="350" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow-job-update-2" value="" style="endArrow=classic;html=1;rounded=0;strokeWidth=1;strokeColor=#388E3C;dashed=1;" edge="1" parent="1" source="update-job-2" target="table-file-job">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="400" as="sourcePoint" />
            <mxPoint x="450" y="350" as="targetPoint" />
            <Array as="points">
              <mxPoint x="800" y="643" />
              <mxPoint x="800" y="250" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <!-- Retry Mechanism Box -->
        <mxCell id="retry-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFEBEE;strokeColor=#C62828;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="900" width="1100" height="140" as="geometry" />
        </mxCell>
        
        <mxCell id="retry-title" value="&lt;b&gt;RETRY MECHANISM&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1;fontColor=#B71C1C;" vertex="1" parent="1">
          <mxGeometry x="50" y="910" width="180" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="retry-attempt0" value="&lt;b&gt;Attempt 1&lt;/b&gt; (retry_count=0)&lt;br&gt;Initial attachment attempt&lt;br&gt;Immediate processing&lt;br&gt;&lt;br&gt;ðŸ”” N1 sent after this" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#81C784;strokeColor=#388E3C;fontColor=#FFFFFF;fontSize=9;align=left;spacingLeft=5;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="60" y="950" width="300" height="70" as="geometry" />
        </mxCell>
        
        <mxCell id="retry-attempt1" value="&lt;b&gt;Attempt 2&lt;/b&gt; (retry_count=1)&lt;br&gt;First retry after failure&lt;br&gt;next_retry_at = +6 hours" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFB74D;strokeColor=#F57C00;fontColor=#FFFFFF;fontSize=9;align=left;spacingLeft=5;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="400" y="950" width="300" height="70" as="geometry" />
        </mxCell>
        
        <mxCell id="retry-attempt2" value="&lt;b&gt;Attempt 3&lt;/b&gt; (retry_count=2)&lt;br&gt;Second/final retry&lt;br&gt;next_retry_at = +6 hours&lt;br&gt;If fails â†’ ERROR (terminal)&lt;br&gt;&lt;br&gt;âœ… N2 sent after all complete" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E57373;strokeColor=#C62828;fontColor=#FFFFFF;fontSize=9;align=left;spacingLeft=5;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="740" y="950" width="300" height="70" as="geometry" />
        </mxCell>
        
        <!-- Retry Arrows -->
        <mxCell id="retry-arrow1" value="If fails" style="endArrow=classic;html=1;rounded=0;strokeWidth=3;strokeColor=#F57C00;fontSize=9;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="360" y="985" as="sourcePoint" />
            <mxPoint x="400" y="985" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="retry-arrow2" value="If fails" style="endArrow=classic;html=1;rounded=0;strokeWidth=3;strokeColor=#C62828;fontSize=9;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="700" y="985" as="sourcePoint" />
            <mxPoint x="740" y="985" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Legend -->
        <mxCell id="legend-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F5F5F5;strokeColor=#9E9E9E;" vertex="1" parent="1">
          <mxGeometry x="1520" y="120" width="240" height="180" as="geometry" />
        </mxCell>
        
        <mxCell id="legend-title" value="&lt;b&gt;LEGEND&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1;fontColor=#424242;" vertex="1" parent="1">
          <mxGeometry x="1520" y="130" width="240" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="legend-line1" value="" style="endArrow=classic;html=1;rounded=0;strokeWidth=2;strokeColor=#2E7D32;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1540" y="165" as="sourcePoint" />
            <mxPoint x="1580" y="165" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="legend-text1" value="Data Flow" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="1590" y="158" width="100" height="15" as="geometry" />
        </mxCell>
        
        <mxCell id="legend-line2" value="" style="endArrow=classic;html=1;rounded=0;strokeWidth=2;strokeColor=#1976D2;dashed=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1540" y="185" as="sourcePoint" />
            <mxPoint x="1580" y="185" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="legend-text2" value="Update/Write" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="1590" y="178" width="100" height="15" as="geometry" />
        </mxCell>
        
        <mxCell id="legend-line3" value="" style="endArrow=classic;html=1;rounded=0;strokeWidth=2;strokeColor=#F9A825;curved=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1540" y="205" as="sourcePoint" />
            <mxPoint x="1580" y="205" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="legend-text3" value="Retry Loop" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="1590" y="198" width="100" height="15" as="geometry" />
        </mxCell>
        
        <mxCell id="legend-n1" value="ðŸ”” N1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F57F17;fontSize=8;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="1540" y="225" width="40" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-text-n1" value="After attempt 1" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="1590" y="220" width="100" height="15" as="geometry" />
        </mxCell>
        
        <mxCell id="legend-n2" value="âœ… N2" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=8;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="1540" y="250" width="40" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-text-n2" value="All complete" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="1590" y="245" width="100" height="15" as="geometry" />
        </mxCell>
        
        <mxCell id="legend-note" value="Tables shown:&lt;br&gt;â€¢ file_job (job tracking)&lt;br&gt;â€¢ file_outbox_row (unified)&lt;br&gt;â€¢ file_job_artifact (evidence)&lt;br&gt;â€¢ file_outbox_row_audit" style="text;html=1;strokeColor=#FF6F00;fillColor=#FFF3E0;align=left;verticalAlign=top;whiteSpace=wrap;rounded=1;fontSize=8;spacingLeft=5;spacingTop=3;" vertex="1" parent="1">
          <mxGeometry x="1540" y="275" width="200" height="20" as="geometry" />
        </mxCell>
        
        <!-- Key Features Box -->
        <mxCell id="features-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E8F5E9;strokeColor=#4CAF50;" vertex="1" parent="1">
          <mxGeometry x="40" y="1080" width="1100" height="120" as="geometry" />
        </mxCell>
        
        <mxCell id="features-title" value="&lt;b&gt;KEY FEATURES &amp;amp; TIMING&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1;fontColor=#2E7D32;" vertex="1" parent="1">
          <mxGeometry x="50" y="1090" width="200" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="feature1" value="âœ“ file_job: Tracks overall job (status: PROCESSING â†’ COMPLETED)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="60" y="1120" width="500" height="15" as="geometry" />
        </mxCell>
        
        <mxCell id="feature2" value="âœ“ file_job_artifact: Tracks evidence files with attachment_status" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="60" y="1140" width="500" height="15" as="geometry" />
        </mxCell>
        
        <mxCell id="feature3" value="âœ“ N1 Timing: Sent after first attempt complete (retry_count=0)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#E65100;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="60" y="1160" width="500" height="15" as="geometry" />
        </mxCell>
        
        <mxCell id="feature4" value="âœ“ N2 Timing: Sent after ALL rows reach SUCCESS or ERROR (no PENDING/PUBLISHED/FAILED)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#2E7D32;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="60" y="1180" width="500" height="15" as="geometry" />
        </mxCell>
        
        <mxCell id="feature5" value="âœ“ Evidence Worker: Updates both file_outbox_row &amp;amp; file_job_artifact" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="600" y="1120" width="500" height="15" as="geometry" />
        </mxCell>
        
        <mxCell id="feature6" value="âœ“ Publisher: Queries PENDING + (FAILED &amp;amp;&amp;amp; retry_count&amp;lt;2 &amp;amp;&amp;amp; next_retry_at&amp;lt;=NOW())" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="600" y="1140" width="500" height="15" as="geometry" />
        </mxCell>
        
        <mxCell id="feature7" value="âœ“ Idempotency: UUID keys + Kafka idempotence + consumer checks" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="600" y="1160" width="500" height="15" as="geometry" />
        </mxCell>
        
        <mxCell id="feature8" value="âœ“ Audit Trail: file_outbox_row_audit for PCI-DSS/SOC 2 compliance" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="600" y="1180" width="500" height="15" as="geometry" />
        </mxCell>
        
        <!-- Footer -->
        <mxCell id="footer" value="Stage 1.4 Enhanced - Approved Oct 9, 2025 | World Dispute Platform | Architecture Review Board" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=8;fontColor=#757575;" vertex="1" parent="1">
          <mxGeometry x="400" y="1230" width="900" height="20" as="geometry" />
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>